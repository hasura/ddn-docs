import BaseUrlLink from "@site/src/components/databaseDocs/baseLink";

## What's about to happen

Now that we have a TypeScript files of `api.ts` and `functions.ts`, which represent the OpenAPI spec, we
can now use them to generate Hasura metadata.

## Step 1. Create the Hasura metadata

:::tip Required

<!-- prettier-ignore -->
- <BaseUrlLink to="/getting-started/prerequisites" text="The DDN CLI, VS Code extension, and Docker installed" />
- A new or existing <BaseUrlLink to="/getting-started/init-supergraph" text="supergraph" />
- A new or existing <BaseUrlLink to="/getting-started/init-subgraph" text="subgraph" />

:::

<!-- prettier-ignore -->
Hasura DDN uses a concept called "connector linking" to take configuration files from a data connector and
transform them into an  [NDC-compliant](https://github.com/hasura/ndc-spec) `hml` (Hasura Metadata Language) file as a <BaseUrlLink to="/supergraph-modeling/data-connector-links/" text="DataConnectorLink" /> metadata object.

:::info Typescript and HML, why both?

Basically, metadata objects in `hml` files contain the data connector schema in a
[format](https://github.com/hasura/ndc-spec) which is generic for all connectors. The TypeScript files on the other
hand contain a format specific to the OpenAPI connector. This format just needs to be a representation that the
specific connector understands and can be different for other connectors.

First we generate the schema representation using the `ddn connector introspect` command, and then use that to create
the `DataConnectorLink` hml object with the `ddn connector-link add` and `update` commands.

:::

First to create this `hml` file with the `connector-link add` command and then convert our configuration files into
`hml` syntax and add it to this file with the `connector-link update` command.

Let's name the `hml` file the same as our connector, `my_openapi`:

```bash title="Run the following from the root of your project:"
ddn connector-link add my_openapi \
  --subgraph my_subgraph \
  --configure-host http://local.hasura.dev:8082
```

The new file is scaffolded out at `my_subgraph/metadata/my_openapi/my_openapi.hml`.

Eg:

<details>
  <summary>Click here for an example `hml` `DataConnectorLink` file</summary>

```yaml
kind: DataConnectorLink
version: v1
definition:
  name: my_openapi
  url:
    readWriteUrls:
      read:
        valueFromEnv: MY_SUBGRAPH_MY_OPENAPI_READ_URL
      write:
        valueFromEnv: MY_SUBGRAPH_MY_OPENAPI_WRITE_URL
  schema:
    version: v0.1
    schema:
      scalar_types: {}
      object_types: {}
      collections: []
      functions: []
      procedures: []
    capabilities:
      version: ""
      capabilities:
        query:
          nested_fields: {}
        mutation: {}
```

</details>

The generated file has two environment variables â€” one for reads and one for writes. Because we used the convenience
flag: `--configure-host` on the command, these values are already set in the `.env.my_subgraph` file:

```env
MY_SUBGRAPH_MY_OPENAPI_READ_URL="http://local.hasura.dev:8082"
MY_SUBGRAPH_MY_OPENAPI_WRITE_URL="http://local.hasura.dev:8082"
```

These values are for the OpenAPI connector itself and utilize `local.hasura.dev` to ensure proper resolution within the
docker container.

## Step 2. Start the services

Let's start our docker compose services.

```bash title="From the root of your project, run:"
HASURA_DDN_PAT=$(ddn auth print-pat) docker compose -f docker-compose.hasura.yaml watch
```

This starts our Hasura Engine, observability tools and the OpenAPI connector all together since we added the connector's
Docker compose file to the main `docker-compose.hasura.yaml` file using the `--add-to-compose-file` flag when we
initialized the connector. `HASURA_DDN_PAT=$(ddn auth print-pat)` gives the Hasura Engine access to the DDN CLI's
authentication token.

We can navigate to the following address, with the port modified, to see the schema of our OpenAPI service:

```bash
http://localhost:8082/schema
```

## Step 3. Update the new DataConnectorLink object with metadata for your OpenAPI service

Finally, now that our `DataConnectorLink` has the correct environment variables configured for the OpenAPI connector, we
can run the update command to have the CLI look at the configuration JSON and transform it to reflect our database's
schema in `hml` format:

```bash
ddn connector-link update my_openapi --subgraph my_subgraph
```

After this command runs, you can open the same `my_subgraph/metadata/my_openapi/my_openapi.hml` file and see your
metadata completely scaffolded out for you ðŸŽ‰

<details>
  <summary>Click here for an example `hml` `DataConnectorLink` file with metadata</summary>

```yaml
kind: DataConnectorLink
version: v1
definition:
  name: my_openapi
  url:
    readWriteUrls:
      read:
        valueFromEnv: MY_SUBGRAPH_MY_OPENAPI_READ_URL
      write:
        valueFromEnv: MY_SUBGRAPH_MY_OPENAPI_WRITE_URL
  schema:
    version: v0.1
    schema:
      scalar_types:
        '"available" | "pending" | "sold"':
          aggregate_functions: {}
          comparison_operators: {}
        '"placed" | "approved" | "delivered"':
          aggregate_functions: {}
          comparison_operators: {}
        Boolean:
          representation:
            type: boolean
          aggregate_functions: {}
          comparison_operators:
            _eq:
              type: equal
        Float:
          representation:
            type: float64
          aggregate_functions: {}
          comparison_operators:
            _eq:
              type: equal
        JSON:
          representation:
            type: json
          aggregate_functions: {}
          comparison_operators: {}
        String:
          representation:
            type: string
          aggregate_functions: {}
          comparison_operators:
            _eq:
              type: equal
      object_types:
        ApiResponse:
          fields:
            code:
              type:
                type: nullable
                underlying_type:
                  type: named
                  name: Float
            message:
              type:
                type: nullable
                underlying_type:
                  type: named
                  name: String
            type:
              type:
                type: nullable
                underlying_type:
                  type: named
                  name: String
        Category:
          fields:
            id:
              type:
                type: nullable
                underlying_type:
                  type: named
                  name: Float
            name:
              type:
                type: nullable
                underlying_type:
                  type: named
                  name: String
        Order:
          fields:
            complete:
              type:
                type: nullable
                underlying_type:
                  type: named
                  name: Boolean
            id:
              type:
                type: nullable
                underlying_type:
                  type: named
                  name: Float
            petId:
              type:
                type: nullable
                underlying_type:
                  type: named
                  name: Float
            quantity:
              type:
                type: nullable
                underlying_type:
                  type: named
                  name: Float
            shipDate:
              type:
                type: nullable
                underlying_type:
                  type: named
                  name: String
            status:
              description: Order Status
              type:
                type: nullable
                underlying_type:
                  type: named
                  name: '"placed" | "approved" | "delivered"'
        Pet:
          fields:
            category:
              type:
                type: nullable
                underlying_type:
                  type: named
                  name: Category
            id:
              type:
                type: nullable
                underlying_type:
                  type: named
                  name: Float
            name:
              type:
                type: named
                name: String
            photoUrls:
              type:
                type: array
                element_type:
                  type: named
                  name: String
            status:
              description: pet status in the store
              type:
                type: nullable
                underlying_type:
                  type: named
                  name: '"available" | "pending" | "sold"'
            tags:
              type:
                type: nullable
                underlying_type:
                  type: array
                  element_type:
                    type: named
                    name: Tag
        Tag:
          fields:
            id:
              type:
                type: nullable
                underlying_type:
                  type: named
                  name: Float
            name:
              type:
                type: nullable
                underlying_type:
                  type: named
                  name: String
        User:
          fields:
            email:
              type:
                type: nullable
                underlying_type:
                  type: named
                  name: String
            firstName:
              type:
                type: nullable
                underlying_type:
                  type: named
                  name: String
            id:
              type:
                type: nullable
                underlying_type:
                  type: named
                  name: Float
            lastName:
              type:
                type: nullable
                underlying_type:
                  type: named
                  name: String
            password:
              type:
                type: nullable
                underlying_type:
                  type: named
                  name: String
            phone:
              type:
                type: nullable
                underlying_type:
                  type: named
                  name: String
            userStatus:
              description: User Status
              type:
                type: nullable
                underlying_type:
                  type: named
                  name: Float
            username:
              type:
                type: nullable
                underlying_type:
                  type: named
                  name: String
        getPetFindPetsByStatus_query:
          fields:
            status:
              description: Status values that need to be considered for filter
              type:
                type: nullable
                underlying_type:
                  type: named
                  name: '"available" | "pending" | "sold"'
        getPetFindPetsByTags_query:
          fields:
            tags:
              description: Tags to filter by
              type:
                type: nullable
                underlying_type:
                  type: array
                  element_type:
                    type: named
                    name: String
        getUserLoginUser_query:
          fields:
            password:
              description: The password for login in clear text
              type:
                type: nullable
                underlying_type:
                  type: named
                  name: String
            username:
              description: The user name for login
              type:
                type: nullable
                underlying_type:
                  type: named
                  name: String
        postPetUpdatePetWithForm_query:
          fields:
            name:
              description: Name of pet that needs to be updated
              type:
                type: nullable
                underlying_type:
                  type: named
                  name: String
            status:
              description: Status of pet that needs to be updated
              type:
                type: nullable
                underlying_type:
                  type: named
                  name: String
        postPetUploadFile_query:
          fields:
            additionalMetadata:
              description: Additional Metadata
              type:
                type: nullable
                underlying_type:
                  type: named
                  name: String
      collections: []
      functions:
        - name: getPetFindPetsByStatus
          description: Finds Pets by status
          arguments:
            headers:
              type:
                type: nullable
                underlying_type:
                  type: named
                  name: JSON
            query:
              type:
                type: named
                name: getPetFindPetsByStatus_query
          result_type:
            type: array
            element_type:
              type: named
              name: Pet
        - name: getPetFindPetsByTags
          description: Finds Pets by tags
          arguments:
            headers:
              type:
                type: nullable
                underlying_type:
                  type: named
                  name: JSON
            query:
              type:
                type: named
                name: getPetFindPetsByTags_query
          result_type:
            type: array
            element_type:
              type: named
              name: Pet
        - name: getPetGetPetById
          description: Find pet by ID
          arguments:
            headers:
              type:
                type: nullable
                underlying_type:
                  type: named
                  name: JSON
            petId:
              description: ID of pet to return
              type:
                type: named
                name: Float
          result_type:
            type: named
            name: Pet
        - name: getStoreGetInventory
          description: Returns pet inventories by status
          arguments:
            headers:
              type:
                type: nullable
                underlying_type:
                  type: named
                  name: JSON
          result_type:
            type: named
            name: JSON
        - name: getStoreGetOrderById
          description: Find purchase order by ID
          arguments:
            headers:
              type:
                type: nullable
                underlying_type:
                  type: named
                  name: JSON
            orderId:
              description: ID of order that needs to be fetched
              type:
                type: named
                name: Float
          result_type:
            type: named
            name: Order
        - name: getUserLoginUser
          description: Logs user into the system
          arguments:
            headers:
              type:
                type: nullable
                underlying_type:
                  type: named
                  name: JSON
            query:
              type:
                type: named
                name: getUserLoginUser_query
          result_type:
            type: named
            name: String
        - name: getUserLogoutUser
          description: Logs out current logged in user session
          arguments:
            headers:
              type:
                type: nullable
                underlying_type:
                  type: named
                  name: JSON
          result_type:
            type: named
            name: JSON
        - name: getUserGetUserByName
          description: Get user by user name
          arguments:
            headers:
              type:
                type: nullable
                underlying_type:
                  type: named
                  name: JSON
            username:
              description: The name that needs to be fetched. Use user1 for testing.
              type:
                type: named
                name: String
          result_type:
            type: named
            name: User
      procedures:
        - name: putPetUpdatePet
          description: Update an existing pet
          arguments:
            data:
              description: Request body
              type:
                type: named
                name: Pet
            headers:
              type:
                type: nullable
                underlying_type:
                  type: named
                  name: JSON
          result_type:
            type: named
            name: Pet
        - name: postPetAddPet
          description: Add a new pet to the store
          arguments:
            data:
              description: Request body
              type:
                type: named
                name: Pet
            headers:
              type:
                type: nullable
                underlying_type:
                  type: named
                  name: JSON
          result_type:
            type: named
            name: Pet
        - name: postPetUpdatePetWithForm
          description: Updates a pet in the store with form data
          arguments:
            headers:
              type:
                type: nullable
                underlying_type:
                  type: named
                  name: JSON
            petId:
              description: ID of pet that needs to be updated
              type:
                type: named
                name: Float
            query:
              type:
                type: named
                name: postPetUpdatePetWithForm_query
          result_type:
            type: named
            name: JSON
        - name: deletePetDeletePet
          description: Deletes a pet
          arguments:
            headers:
              type:
                type: nullable
                underlying_type:
                  type: named
                  name: JSON
            petId:
              description: Pet id to delete
              type:
                type: named
                name: Float
          result_type:
            type: named
            name: JSON
        - name: postStorePlaceOrder
          description: Place an order for a pet
          arguments:
            data:
              description: Request body
              type:
                type: named
                name: Order
            headers:
              type:
                type: nullable
                underlying_type:
                  type: named
                  name: JSON
          result_type:
            type: named
            name: Order
        - name: deleteStoreDeleteOrder
          description: Delete purchase order by ID
          arguments:
            headers:
              type:
                type: nullable
                underlying_type:
                  type: named
                  name: JSON
            orderId:
              description: ID of the order that needs to be deleted
              type:
                type: named
                name: Float
          result_type:
            type: named
            name: JSON
        - name: postUserCreateUser
          description: Create user
          arguments:
            data:
              description: Request body
              type:
                type: named
                name: User
            headers:
              type:
                type: nullable
                underlying_type:
                  type: named
                  name: JSON
          result_type:
            type: named
            name: JSON
        - name: postUserCreateUsersWithListInput
          description: Creates list of users with given input array
          arguments:
            data:
              description: Request body
              type:
                type: array
                element_type:
                  type: named
                  name: User
            headers:
              type:
                type: nullable
                underlying_type:
                  type: named
                  name: JSON
          result_type:
            type: named
            name: User
        - name: putUserUpdateUser
          description: Update user
          arguments:
            data:
              description: Request body
              type:
                type: named
                name: User
            headers:
              type:
                type: nullable
                underlying_type:
                  type: named
                  name: JSON
            username:
              description: name that needs to be updated
              type:
                type: named
                name: String
          result_type:
            type: named
            name: JSON
        - name: deleteUserDeleteUser
          description: Delete user
          arguments:
            headers:
              type:
                type: nullable
                underlying_type:
                  type: named
                  name: JSON
            username:
              description: The name that needs to be deleted
              type:
                type: named
                name: String
          result_type:
            type: named
            name: JSON
    capabilities:
      version: 0.1.2
      capabilities:
        query:
          variables: {}
          nested_fields: {}
        mutation: {}
```

</details>

## What did this do?

By creating a `my_openapi.hml` file, we've provided Hasura with a link between our original data source and the types
which we'll eventually expose via our API.

## Next steps

<!-- prettier-ignore -->
With a data connector fully configured, you can now start to create metadata for each table and view in your OpenAPI
database using `hml`. Learn how to do this by <BaseUrlLink to="/getting-started/connect-to-data/add-source-entities" text="adding source entities" />.
