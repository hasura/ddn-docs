import BaseUrlLink from '@site/src/components/databaseDocs/baseLink';

## What's about to happen?

If you have an API defined in an [OpenAPI](https://www.openapis.org/) spec format, you can easily and quickly connect
it to your Supergraph as well as modify the calls to those endpoints to introduce your own logic.

To do this, we use the Hasura [OpenAPI Lambda data connector](https://github.com/hasura/ndc-open-api-lambda) to
facilitate the connection, introspect the connection to generate Typescript functions, and then use the Hasura CLI
will to create metadata from them which defines our API.

## Step 1. Initialize the OpenAPI connector

:::tip Required

- <BaseUrlLink to="/getting-started/prerequisites" text="The DDN CLI, VS Code extension, and Docker installed" />
- A new or existing <BaseUrlLink to="/getting-started/init-supergraph" text="supergraph" />
- A new or existing <BaseUrlLink to="/getting-started/init-subgraph" text="subgraph" />

:::

To initialize the OpenAPI connector, run the following in your terminal:

```bash
ddn connector init my_openapi \
  --subgraph my_subgraph \
  --hub-connector hasura/openapi \
  --configure-port 8082 \
  --add-to-compose-file docker-compose.hasura.yaml
```

With this `connector init` command, we're passing a few important values.

**Connector name**

We're naming the connector `my_openapi` in this example, but you can call it whatever makes sense to you. For
example, if this connector is integrating an OpenAPI spec regarding payments, it would make sense to name it
something like `payments_api`.

**Subgraph: `--subgraph`**

We're specifying the subgraph that this connector will be added to using the `--subgraph` flag.

**Connector: --hub-connector**

We're specifying that this connector should be the: `hasura/openapi`, connector listed in the
[Connector Hub](https://hasura.io/connectors/openapi).

**Port: `configure-port`**

We're specifying the port to run the connector on. This is important to avoid port collisions with other connectors or
services which you might have running on your machine. Remember to use a different port for each connector or
service you may have running.

**Compose file: `--add-to-compose-file`**

We're specifying the `--add-to-compose-file` flag to add the connector's **own** Docker compose file to the main
`docker-compose.hasura.yaml` file. This is for convenience and allows us to start the Hasura Engine and connectors
together.

:::tip Best practices

Importantly, a data connector can only connect to one data source.

The project will be kept organized with each data connector's configuration located in a relevant subgraph directory. In
this example the CLI will create a `my_subgraph/connector/my_openapi` directory if it doesn't exist. You can also change
this directory by passing a `--dir` flag to the CLI.

The name of the connector and the directory in which the configuration is stored, `my_openapi` in this example, should
match for convenience and clarity sake.

In subsequent steps, when running your connector locally, it's critical to ensure the port value matches the connection
string you provide in your subgraph's `.env.my_subgraph` file.

:::

### What did this do?

In the `my_subgraph/connector/my_openapi` directory which we specified in the command, the CLI created:

- A `connector.local.yaml` file which contains the local configuration for the connector.
- A `connector.cloud.yaml` file which contains the cloud configuration for the connector.
- A `.hasura-connector/connector-metadata.yaml` file which contains extra metadata for the connector.
- A `docker-compose.my_openapi.yaml` a file to run the OpenAPI data connector locally in Docker. Includes the
specified port.
- A placeholder `.ddnignore` file to prevent unnecessary files from being included in the build.
- An `.env.local` placeholder file for environment variables for pertaining to running this connector locally.

Right now, the CLI has only scaffolded out configuration files for the data connector. Our connector still knows nothing
about the OpenAPI file or endpoint. That's coming up in the next steps.

## Step 2. Add the OpenAPI connection URI or file

Now that our OpenAPI data connector has been scaffolded out for us, we need to provide it a **connection string** or
**swagger file** of the OpenAPI spec for the service.

In the `.env.local` file which the CLI has provided for our connector, we can add the `NDC_OAS_DOCUMENT_URI` environment
variable which should point to the OpenAPI document. If you're using a file instead of a HTTP link, please ensure
that it is named `swagger.json` and is present in the root directory of the volume which is mounted to
`/etc/connector` (for this tutorial, the `swagger.json` file should be present at `my_subgraph/connector/my_openapi/`).

The `.env.local` file should look (at least) like this:

```text
OTEL_EXPORTER_OTLP_TRACES_ENDPOINT=http://local.hasura.dev:4317
OTEL_SERVICE_NAME=my_subgraph_my_openapi
NDC_OAS_DOCUMENT_URI=https://petstore3.swagger.io/api/v3/openapi.json
```

The OpenAPI connector can also be configured with the following optional environment variables:

1. `NDC_OAS_BASE_URL` (optional): The base URL of your API.
2. `NDC_OAS_FILE_OVERWRITE` (optional): A Boolean flag to allow previously generated files to be over-written.
Defaults to `false`.
3. `HASURA_PLUGIN_LOG_LEVEL` (optional): The log level. Possible values: `trace`, `debug`, `info`, `warn`, `error`,
`fatal`, `panic`. Defaults to `info`
4. `NDC_OAS_LAMBDA_PRETTY_LOGS` (optional): A Boolean flag to print human readable logs instead of JSON. Defaults to
`false`


:::tip Need a test OpenAPI document?

Feel free to use the pet store OpenAPI document available at:

```text
https://petstore3.swagger.io/api/v3/openapi.json
```

:::

These environment variables are already referenced in the scaffolded out `my_subgraph/connector/my_openapi/.
hasura-connector/connector-metadata.yaml` file.

## Step 3. Introspect your OpenAPI document

This will introspect your OpenAPI document and files required to run the Typescript project.


```bash
ddn connector introspect --connector my_subgraph/connector/my_openapi/connector.local.yaml
```

### What did this do?

We specify the connector (and by proxy, the API) that we want to introspect with the `--connector` flag and
provide it with the location of that `connector.local.yaml` configuration file.

The CLI will introspect the OpenAPI document and create an `api.ts` file, a `functions.ts` file and other supporting
files in the `my_subgraph/connector/my_openapi` directory.

- The `api.ts` file contains the Data Types and API calls from the OpenAPI document.
- The `functions.ts` file contains functions that wrap API calls. You can modify this `functions.ts` file to introduce
extra business logic.

See Saving User Changes if you want to preserve your changes in this file when you introspect the OpenAPI document
again.

:::tip o11y via OpenTelemetry

Yes! Connectors ship with OTEL-enabled tracing available, out of the box ðŸŽ‰

:::

## Next steps

<!-- prettier-ignore -->
With these TypeScript files, which represent the endpoints in the OpenAPI document, we can now use it to
<BaseUrlLink to="/getting-started/connect-to-data/create-source-metadata" text="generate Hasura metadata" />.
