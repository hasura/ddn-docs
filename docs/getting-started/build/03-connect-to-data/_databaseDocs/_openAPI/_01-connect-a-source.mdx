import Thumbnail from "@site/src/components/Thumbnail";

## What's about to happen?

You can easily and quickly connect any API defined in the [OpenAPI](https://www.openapis.org/) spec format to your
Supergraph.

To do this, we use the Hasura [OpenAPI Lambda data connector](https://github.com/hasura/ndc-open-api-lambda) to
facilitate the connection. Then, with the Hasura CLI, we introspect the OpenAPI document to generate Typescript
functions, and then use those to create Hasura metadata which defines our API.

In addition, once we've generated functions from our OpenAPI document, we can modify them or add new ones to implement
additional business logic.

<Thumbnail src="/img/get-started/ERD/connect-data.png" alt="Connect a data source" width="1000px" />

## Step 1. Initialize the OpenAPI connector

:::tip Required

- [The DDN CLI, VS Code extension, and Docker installed](/getting-started/build/00-prerequisites.mdx)
- A new or existing [supergraph](/getting-started/build/01-init-supergraph.mdx)
- A new or existing [subgraph](/getting-started/build/02-init-subgraph.mdx)

:::

```bash title="Run the following command:"
ddn connector init -i
```

- Select `hasura/openapi` from the list of connectors.
- Name it something descriptive. For this example, we'll call it `my_openapi`.
- Choose a port (press enter to accept the default recommended by the CLI).
- Enter your connection details. For more information, see Step 2 below.

:::tip Best practices

Importantly, a data connector can only connect to one data source.

The project will be kept organized with each data connector's configuration located in a relevant subgraph directory. In
this example the CLI will create a `my_subgraph/connector/my_openapi` directory if it doesn't exist. You can also change
this directory by passing a `--dir` flag to the CLI.

We recommend that the name of the connector and the directory in which the configuration is stored, `my_openapi` in this
example, should match for convenience and clarity sake for this tutorial, but it can be anything you want.

In subsequent steps, when running your connector locally, it's critical to ensure the port value matches the connection
string you provide in the key-value pair for your `.env` file.

:::

### What did `connector init` do?

In the `my_subgraph/connector/my_openapi` directory which we specified in the command, the CLI created:

- A `connector.yaml` file which contains the local configuration for the connector.
- A `.hasura-connector` folder which contains the connector definition used to build and run it.
- A `compose.yaml` a file to run the OpenAPI data connector locally in Docker. Includes the specified port.
- A placeholder `.ddnignore` file to prevent unnecessary files from being included in the build.

In the `my_subgraph/metadata` directory, the CLI created:

- A `my_openapi.hml` file which contains the [`DataConnectorLink`](/supergraph-modeling/data-connector-links.mdx)
  metadata object which describes how the supergraph can interact with the connector.

Right now, the CLI has only scaffolded out configuration files for the data connector. Our connector still knows nothing
about the OpenAPI document. That's coming up in the next steps.

## Step 2. Specifying the OpenAPI document location

In the root `.env` file, we can add the `MY_OPENAPI_NDC_OAS_DOCUMENT_URI` environment variable which should point to the
OpenAPI document. If you're using a file instead of a HTTP link, please ensure that it is named `swagger.json` and is
present in the root directory of the volume which is mounted to `/etc/connector` (for this tutorial, the `swagger.json`
file should be present at `my_subgraph/connector/my_openapi/`).

```text
MY_OPENAPI_NDC_OAS_DOCUMENT_URI=<your-openapi-document-uri>
```

This OpenAPI document is only used in the next, `connector introspect` step to generate the TypeScript files.

:::tip Need a test OpenAPI document URI?

Feel free to use the pet store OpenAPI document available at:

```text
https://petstore3.swagger.io/api/v3/openapi.json
```

:::

### Specifying the OpenAPI base URL

You can also add the `NDC_OAS_BASE_URL` optional environment variable to the `.env.local` file. This should point to the
**base URL** of the API. Eg: `NDC_OAS_BASE_URL=https://petstore3.swagger.io/api/v3` This will then be used as a string
literal in the `functions.ts` file which will be generated in the next step in order for our functions to make API
calls.

eg:

```text
NDC_OAS_BASE_URL=https://petstore3.swagger.io/api/v3
```

_Alternatively_, you can edit this value directly at the top of the `functions.ts` file manually later. Eg:

```typescript
const api = new Api({
  baseUrl: "https://petstore3.swagger.io/api/v3",
});
```

You can also implement additional logic in the `functions.ts` file to handle different endpoints or headers.

### Additional environment variables

The OpenAPI connector can also be configured with the following **extra optional environment variables**:

- `NDC_OAS_FILE_OVERWRITE` (optional): A Boolean flag to allow previously generated files to be overwritten. Defaults to
  `false`.
- `HASURA_PLUGIN_LOG_LEVEL` (optional): The log level. Possible values: `trace`, `debug`, `info`, `warn`, `error`,
  `fatal`, `panic`. Defaults to `info`
- `NDC_OAS_LAMBDA_PRETTY_LOGS` (optional): A Boolean flag to print human-readable logs instead of JSON. Defaults to
  `false`

These environment variables are already referenced in the scaffolded out
`my_subgraph/connector/my_openapi/.hasura-connector/connector-metadata.yaml` file.

## Step 3. Introspect your OpenAPI document

This will introspect your OpenAPI document and files required to run the Typescript project.

```bash
ddn connector introspect my_openapi --add-all-resources
```

## What did `connector introspect` do?

In your terminal window, the CLI started your connector using its `compose.yaml` and then fetched the schema of your
OpenAPI spec.

The CLI will introspect the OpenAPI document and create an `api.ts` file, a `functions.ts` file and other supporting
files in the `my_subgraph/connector/my_openapi` directory.

- The `api.ts` file contains the Data Types and API calls from the OpenAPI document.
- The `functions.ts` file contains functions that wrap API calls. You can modify this `functions.ts` file to introduce
  extra business logic.

Additionally, the CLI updated the `DataConnectorLink` object with the latest metadata to interact with the connector.

:::tip o11y via OpenTelemetry

Yes! Connectors ship with OTEL-enabled tracing available, out of the box ðŸŽ‰

:::

:::note Regenerating the functions file

The introspection process checks to see if there are any changes in the `api.ts` file in order to determine if it needs
to regenerate files. If you make changes to the `api.ts` file, you can run the `connector introspect` command again to
regenerate the files again. They will only be overwritten if the `NDC_OAS_FILE_OVERWRITE` environment variable is set to
`true`.

:::

## Step 4. Create a new build and restart the services

To reflect the changes in your API, create a new build.

```bash title= "Run the following:"
ddn supergraph build local
```

And, if your services are not already running, start them.

```bash title="Run the following:"
ddn run docker-start
```

You should see your models available in your API at
[`https://console.hasura.io/local/graphql?url=http://localhost:3000`](https://console.hasura.io/local/graphql?url=http://localhost:3000)
ðŸŽ‰

If you want a quick way of opening the console, you can run the following command:

```bash title="Run:"
ddn console -l
```

## Next steps

With our data source connected and all of our models tracked, we can move on to
[add custom authorization rules](/getting-started/build/05-add-permissions.mdx) using permissions,
[incorporate custom business logic](/getting-started/build/06-add-business-logic.mdx), or
[create relationships](/getting-started/build/07-create-a-relationship.mdx) across data sources!
